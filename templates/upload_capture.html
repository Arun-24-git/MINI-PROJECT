{% extends 'staff_layout.html' %}
{% block title %}Capture & Process Image{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="text-center mb-4">
        <h2>Capture Postal Letter Image</h2>
        <p class="text-muted">Use the camera to add images to the queue, then start processing.</p>
    </div>

    <div class="row g-4 justify-content-center">
        <div class="col-md-6">
            <div class="card h-100 text-center shadow-sm">
                <div class="card-body d-flex flex-column justify-content-center align-items-center" style="min-height: 200px;">
                    <i class="fas fa-camera fa-3x text-success mb-3"></i>
                    <h5 class="card-title">Capture Image</h5>
                    <p class="card-text">Use your device's camera to take a photo.</p>
                    <button class="btn btn-success" id="openCameraBtn">Open Camera</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5 justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header"><h4><i class="fas fa-list-alt me-2"></i>Image Queue (<span id="queue-count">0</span>)</h4></div>
                <div class="card-body" id="image-queue-body"><ul class="list-group" id="image-queue-list"><li class="list-group-item text-center text-muted" id="empty-queue-message">Your queue is empty.</li></ul></div>
                <div class="card-footer text-center"><button class="btn btn-lg btn-info" id="startProcessingBtn" disabled><i class="fas fa-cogs me-2"></i>Start Processing</button></div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="modal fade" id="cameraModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Live Camera Feed</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" id="closeCameraBtn"></button>
                </div>
                <div class="modal-body text-center position-relative">
                    <div id="camera-overlay">
                        <div class="focus-box"></div>
                        <p id="capture-instructions">Center the address in the box and hold steady</p>
                    </div>
                    <video id="camera-feed" width="100%" autoplay playsinline></video>
                    <canvas id="camera-canvas" style="display:none;"></canvas>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="captureBtn"><i class="fas fa-camera-retro"></i> Capture Photo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Processing Completed</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">The extracted address and pincode for all pictures are shown below. Please verify, correct any errors, and click 'Sort'.</p>
                    <div id="results-container" class="list-group">
                        <!-- Results will be injected here by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="finalize-status" class="me-auto fw-bold"></div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sortBtn">
                        <i class="fas fa-check-double me-2"></i>Sort
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Full-page loading overlay for animation transition -->
<div id="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Preparing Sorting Animation...</p>
</div>
{% endblock %}

{% block scripts %}
{{ super() if super }}
<style>
    #camera-feed { max-height: 65vh; object-fit: contain; background-color: #000; }
    #camera-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; }
    .focus-box { width: 80%; height: 50%; border: 3px dashed rgba(255, 255, 255, 0.7); border-radius: 10px; }
    #capture-instructions { color: white; background-color: rgba(0, 0, 0, 0.5); padding: 5px 10px; border-radius: 5px; margin-top: 15px; font-weight: bold; }
    .result-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; }
    .result-item-img { width: 100px; height: 75px; object-fit: cover; border-radius: 0.25rem; border: 1px solid #dee2e6; }
    .result-item-content { flex-grow: 1; }
    .result-item-address { white-space: pre-wrap; font-size: 0.9rem; max-height: 80px; overflow-y: auto; background-color: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; }

    /* --- CSS for the Loading Overlay --- */
    #loading-overlay {
        position: fixed; /* Cover the entire viewport */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white background */
        z-index: 9999; /* Ensure it's on top of everything */
        display: none; /* Hidden by default */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #333;
        font-size: 1.2rem;
    }

    .loading-spinner {
        border: 8px solid #f3f3f3; /* Light grey */
        border-top: 8px solid #0d6efd; /* Blue */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- SETUP AND CONSTANTS ---
    const queueList = document.getElementById('image-queue-list');
    const emptyMessage = document.getElementById('empty-queue-message');
    const queueCountSpan = document.getElementById('queue-count');
    const startBtn = document.getElementById('startProcessingBtn');
    
    const openCameraBtn = document.getElementById('openCameraBtn');
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
    const closeCameraBtn = document.getElementById('closeCameraBtn');
    const videoElement = document.getElementById('camera-feed');
    const canvasElement = document.getElementById('camera-canvas');
    const captureBtn = document.getElementById('captureBtn');
    
    const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
    const sortBtn = document.getElementById('sortBtn');

    let stream = null; 
    let imageQueue = [];

    // --- CAMERA AND QUEUE LOGIC ---
    function addFileToQueue(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            imageQueue.push({ file: file, dataURL: e.target.result });
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.innerHTML = `<span><img src="${e.target.result}" alt="${file.name}" width="50" class="me-3 rounded">${file.name}</span><button class="btn btn-sm btn-danger remove-btn">&times;</button>`;
            
            listItem.querySelector('.remove-btn').addEventListener('click', () => {
                const index = imageQueue.findIndex(item => item.file === file);
                if (index > -1) imageQueue.splice(index, 1);
                listItem.remove();
                updateQueueState();
            });

            if (emptyMessage) emptyMessage.style.display = 'none';
            queueList.appendChild(listItem);
            updateQueueState();
        };
        reader.readAsDataURL(file);
    }
    
    const updateQueueState = () => {
        const count = imageQueue.length;
        queueCountSpan.textContent = count;
        startBtn.disabled = count === 0;
        if (emptyMessage) emptyMessage.style.display = count === 0 ? 'block' : 'none';
    };

    openCameraBtn.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            videoElement.srcObject = stream;
            cameraModal.show();
        } catch (err) { console.error("Camera Error:", err); alert("Could not access camera."); }
    });

    captureBtn.addEventListener('click', () => {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasElement.getContext('2d').drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
        canvasElement.toBlob((blob) => {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const capturedFile = new File([blob], `capture-${timestamp}.jpg`, { type: 'image/jpeg' });
            addFileToQueue(capturedFile);
            cameraModal.hide();
        }, 'image/jpeg', 0.95);
    });

    const stopCamera = () => { if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; } };
    closeCameraBtn.addEventListener('click', stopCamera);
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', stopCamera);

    startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        startBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
        const formData = new FormData();
        imageQueue.forEach(item => formData.append('images[]', item.file));
        try {
            const response = await fetch("{{ url_for('process_queue') }}", { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Server Error: ${response.statusText}`);
            const results = await response.json();
            displayResultsInModal(results);
        } catch (error) {
            alert('Processing failed: ' + error.message);
        } finally {
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Start Processing';
        }
    });

    function displayResultsInModal(results) {
        const container = document.getElementById('results-container');
        container.innerHTML = '';

        results.forEach((res, index) => {
            const imgSrc = imageQueue[index] ? imageQueue[index].dataURL : '';
            const pincodeValue = res.extracted_pincode && res.extracted_pincode !== 'Not Found' ? res.extracted_pincode : '';
            const hasError = res.status !== 'Success' || !pincodeValue;

            const resultItemHTML = `
                <div class="list-group-item result-item ${hasError ? 'list-group-item-danger' : ''}" 
                     data-image-path="${res.image_path}" 
                     data-full-address="${res.extracted_address || ''}">
                    <img src="${imgSrc}" alt="${res.original_filename}" class="result-item-img">
                    <div class="result-item-content">
                        <label class="form-label small">Extracted Address</label>
                        <div class="result-item-address">${res.extracted_address || 'N/A'}</div>
                    </div>
                    <div class="w-25">
                         <label for="pincode-${index}" class="form-label small">${hasError ? '<b>Enter Pincode</b>' : 'Pincode'}</label>
                         <input type="text" id="pincode-${index}" class="form-control pincode-input" 
                                value="${pincodeValue}" placeholder="6 digits" maxlength="6">
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', resultItemHTML);
        });

        document.getElementById('finalize-status').innerHTML = '';
        resultsModal.show();
    }

    // --- FULLY UPDATED sortBtn EVENT LISTENER ---
    sortBtn.addEventListener('click', async () => {
        const rows = document.querySelectorAll('#results-container .result-item');
        const parcelsToFinalize = [];
        let hasError = false;

        rows.forEach(row => {
            const pincodeInput = row.querySelector('.pincode-input');
            const pincode = pincodeInput.value.trim();
            pincodeInput.classList.remove('is-invalid');

            // A pincode is only invalid if it's NOT empty and NOT exactly 6 digits.
            if (pincode && pincode.length !== 6) { 
                pincodeInput.classList.add('is-invalid');
                hasError = true;
            }

            parcelsToFinalize.push({
                image_path: row.dataset.imagePath,
                pincode: pincode,
                address: row.dataset.fullAddress
            });
        });

        if (hasError) {
            alert('Please correct the highlighted pincodes. A pincode must be exactly 6 digits or left empty if unknown.');
            return;
        }

        // Hide the results modal immediately.
        resultsModal.hide();
        
        // Show our full-page loading overlay.
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';

        try {
            const response = await fetch("{{ url_for('finalize_and_sort') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ parcels: parcelsToFinalize })
            });
            const result = await response.json();
            if (!response.ok || !result.success) {
                throw new Error(result.message || 'Failed to save data.');
            }

            // The browser will now navigate to the animation page.
            window.location.href = result.redirect_url;

        } catch (error) {
            // If something goes wrong, hide the overlay and show an error.
            loadingOverlay.style.display = 'none';
            alert(`Error: ${error.message}`);
        }
    });
});
</script>
{% endblock %}
